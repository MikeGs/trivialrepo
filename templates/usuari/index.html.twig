{% extends 'base.html.twig' %}

{% block title %}Usuaris{% endblock %}

{% block body %}
	<div class="card border-0 m-5">
		<div class="card-header border-bottom bg-white d-flex justify-content-between p-0">
			<h1 class="h3">USUARIS</h1><a class="btn btn-link link-blue" href="#"><i class="fas fa-arrow-left"></i> TORNAR</a>
		</div>
		<div class="card-body">
			<div class="col-12 p-0 text-right mb-4">
				<a href="{{ path('afegirUsuari') }}" class="btn customAddBtn"><i class="fas fa-plus"></i> Afegir usuari</a>
			</div>
			<div class="col-12 p-0 text-right mb-4">
				LLegenda: 
				<span class="text-blue"><i class="fas fa-sitemap ml-3 mr-1"></i> Assignar grup</span>
				<span class="text-orange"><i class="fas fa-wrench ml-3 mr-1"></i></i> Assignar rol</span>
				<span class="text-red"><i class="fas fa-trash-alt ml-3 mr-1"></i> Eliminar</span>

			</div>
			<table class="table w-100 custom-table" id="llistatUsuaris">
				<thead class="custom-thead">
					<tr>
						<th>Nom</th>
						<th>Nom d'usuari</th>
						<th>Correu electrònic</th>
						<th>Rol</th>
						<th>Grup</th>
						<th>Última connexió</th>
						<th>Accions</th>
					</tr>
				</thead>
				<tbody>
					{% for usuari in usuaris %}
					<tr>
						<td>{{ usuari.nom }} {{ usuari.cognoms }}</td>
						<td>{{ usuari.username }}</td>
						<td><a href="mailto:{{ usuari.email }}" class="link-blue"><i class="fas fa-envelope"></i> {{ usuari.email }}</a></td>
						<td>
							{% for rol in usuari.roles %}
								{% if rol == 'ROLE_STUDENT' %}
									Estudiant<br>
								{% elseif rol == 'ROLE_TEACHER' %}
									Professor<br>
								{% elseif rol == 'ROLE_ADMIN' %}
									Administrador<br>
								{% endif %}
							{% endfor %}
						</td>
						<td>
							{% for grup in usuari.grups if grup %}
								{{ grup.nom }}<br>
							{% else %}
								No assignat
							{% endfor %}
						</td>
						<td>{{ usuari.lastLogin|date('d-m-Y H:i') }}</td>
						<td>
							<button class="btn btn-link link-blue custom-btn-link assignarGrupBtn" data-id="{{ usuari.id }}" data-usuari="{{ usuari.nom }} {{ usuari.cognoms }}"><i class="fas fa-sitemap"></i></button>
							<button class="btn btn-link link-orange custom-btn-link assignarRolBtn" data-id="{{ usuari.id }}" data-usuari="{{ usuari.nom }} {{ usuari.cognoms }}"><i class="fas fa-wrench"></i></button>
							<button class="btn btn-link link-red custom-btn-link eliminarUsuariBtn" data-id="{{ usuari.id }}" data-usuari="{{ usuari.nom }} {{ usuari.cognoms }}"><i class="fas fa-trash-alt"></i></button>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>

<div id="assignarRolModal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h6 class="modal-title" id="assignarRolModalTitol"></h6>
				<button type="button" class="close cancelAssignarRolBtn" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div id="assignarRolModalMsg">
					<div class="form-group">
						<label for="rol">Selecciona un rol</label>
						<select name="rol" id="rol" class="form-control">
							<option value="">---</option>
							{% for rol in rols|keys if rol != 'ROLE_SUPER_ADMIN' %}
								<option value="{{ rol }}">
									{% if rol == 'ROLE_STUDENT' %}
										Estudiant
									{% elseif rol == 'ROLE_TEACHER' %}
										Professor
									{% elseif rol == 'ROLE_ADMIN' %}
										Administrador
									{% endif %}
								</option>
							{% endfor %}
						</select>
					</div>
				</div>
			</div>
			<div class="modal-footer" id="assignarRolModalBtns">
			</div>
		</div>
	</div>
</div>

<div id="assignarGrupModal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h6 class="modal-title" id="assignarGrupModalTitol"></h6>
				<button type="button" class="close cancelAssignarGrupBtn" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div id="assignarGrupModalMsg">
					<div id="llistatGrupsAlumne"></div>
					<div class="form-group mt-3">
						<label for="rol">Selecciona un grup</label>
						<select name="grup" id="grup" class="form-control">
							<option value="">---</option>
							{% for grup in grups %}
								<option value="{{ grup.id }}">{{ grup.nom }}</option>
							{% endfor %}
						</select>
					</div>
				</div>
			</div>
			<div class="modal-footer" id="assignarGrupModalBtns">
			</div>
		</div>
	</div>
</div>

<div id="eliminarUsuariModal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h6 class="modal-title" id="eliminarUsuariModalTitol"></h6>
				<button type="button" class="close cancelEliminarUsuariBtn" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div id="eliminarUsuariModalMsg">
				</div>
			</div>
			<div class="modal-footer" id="eliminarUsuariModalBtns">
			</div>
		</div>
	</div>
</div>
	
{% endblock %}
{% block javascriptsBottom %}
	{{ parent() }}
	<script>
		$(document).ready( function () {

		    llistatUsuaris = $('#llistatUsuaris').dataTable( {
	            "language": {
	                "url": "https://cdn.datatables.net/plug-ins/1.10.19/i18n/Catalan.json"
	            },
	            "columnDefs": [
	            		{ "orderable": false, "targets": 1 }, 
	            		{ "orderable": false, "targets": 2 }, 
	            		{ "orderable": false, "targets": 3 },
	            		{ "orderable": false, "targets": 4 },
                        { "orderable": false, "targets": 5 },
                        { "orderable": false, "targets": -1 }
                ],
                "order": [[0, "asc"]]
	        });

		    $('body').on( 'click', '.assignarRolBtn', function() {
		    	var id = $(this).data('id');
		    	var usuari = $(this).data('usuari');
		    	$('#assignarRolModalTitol').html(`Assignar un rol a <strong>${usuari}</strong>`);
		    	$('#assignarRolModalBtns').html(`<button class="cancelAssignarRolBtn btn btn-secondary mr-2">Cancel·lar</button><button data-id="${id}" id="rolAssignatBtn" class="btn btn-primary disabled">Continuar</button>`);
		    	$('#assignarRolModal').modal('show');
		    });

		    $('body').on('click', '.cancelAssignarRolBtn', function()  {
		    	$('#rol').prop('selectedIndex',0);
		    	$('#assignarRolModal').modal('hide');
		    });

		    $('body').on('change', '#rol', function() {
		    	if ($(this).val() != '') {
		    		$('#rolAssignatBtn').removeClass('disabled');
		    	} else {
		    		$('#rolAssignatBtn').addClass('disabled');
		    	}
		    });

		    $('body').on('click', '#rolAssignatBtn', function(e) {
		    	var id = $('#rolAssignatBtn').data('id');
		    	var rol = $('#rol').val();
		    	var url = `{{ path('assignarRolAjax') }}`;
		    	$.post(url, { 'idUsuari': id, 'rol': rol }) 
		    		.done(function(response) {
						$('#assignarRolModalMsg').html(`<div class="text-center"><i class="fas fa-check mb-2" style="color: green; font-size: 40px"></i><div>Rol assignat correctament.</div></div>`);
		    			$('#assignarRolModalBtns').html(`<button class="reloadBtn btn btn-primary mr-2">Acceptar</button>`);
		    			
					})
					.fail(errorAssignacioRol);
		    	e.preventDefault();
		    });

		    $('body').on('click', '.reloadBtn', function() {
		    	var reload = `{{ path('usuaris') }}`;
		    	window.location.replace(reload);
		    });

		    function errorAssignacioRol() {
		    	$('#assignarRolModalMsg').html(`<div class="text-center"><i class="fas fa-exclamation-triangle mb-2" style="color: red; font-size: 40px"></i><div>Error! No ha sigut possible assignar el rol a l'usuari.</div></div>`);
		    	$('#assignarRolModalBtns').html(`<button class="reloadBtn btn btn-primary mr-2">Acceptar</button>`);
		    }

		    $('body').on( 'click', '.assignarGrupBtn', function() {
		    	var id = $(this).data('id');
		    	var usuari = $(this).data('usuari');
		    	$('#assignarGrupModalTitol').html(`Assignar un grup a <strong>${usuari}</strong>`);
		    	$('#assignarGrupModalBtns').html(`<button class="cancelAssignarGrupBtn btn btn-secondary mr-2">Cancel·lar</button><button data-id="${id}" id="grupAssignatBtn" class="btn btn-primary disabled">Continuar</button>`);
		    	var url = `{{ path('llistarGrupsAlumneAjax') }}`;
		    	$.post(url, { 'idUsuari' : id })
		    		.done(function(grups) {
		    			var html = '<div class="mb-2">Grups assignats:</div>';
		    			if (grups.length == 0) {
		    				html += `<span class="text-muted pl-4" style="font-size: 12px">Aquest usuari no té alumnes assignats.</span>`;
		    			} else {
		    				for (var i = 0; i < grups.length; i++) {
			    				html += `<div class="w-100 p-2 pl-4 pr-3 bg-list-grey mb-1 rounded align-middle" style="font-size: 12px">
			    							${i+1}. ${grups[i].nom}
			    							<span class="link-grey-times float-right p-0 desvincularAlumneGrup" data-usuari="${id}" data-grup="${grups[i].id}" style="cursor: pointer"><i class="fas fa-times fa-xs"></i></span>
		    							</div>`;
			    			}
		    			}
		    			
		    			$('#llistatGrupsAlumne').html(html);
		    		})
		    		.fail(errorCarregarGrups);
		    	$('#assignarGrupModal').modal('show');
		    });

		    function errorCarregarGrups() {
		    	$('#llistatGrupsAlumne').html(`<div style="font-size: 12px; color: red;">Error al carregar el llistat de grups assignats.</div>`);
		    }

		    $('body').on( 'click', '.desvincularAlumneGrup', function() {
		    	var url = `{{ path('desvincularAlumneGrup') }}`;
		    	$.post(url, { 'idGrup' : $(this).data('grup'), 'idUsuari' : $(this).data('usuari') })
		    		.done(function(grups) {
		    			$('#assignarGrupModalMsg').html(`<div class="text-center"><i class="fas fa-check mb-2" style="color: green; font-size: 40px"></i><div>S'ha desvinculat correctament l'usuari del grup.</div></div>`);
		    			$('#assignarGrupModalBtns').html(`<button class="reloadBtn btn btn-primary mr-2">Acceptar</button>`);
		    		})
		    		.fail(errorDesvincularGrupUsuari);
		    }); 

		    function errorDesvincularGrupUsuari() {
		    	$('#assignarGrupModalMsg').html(`<div class="text-center"><i class="fas fa-exclamation-triangle mb-2" style="color: red; font-size: 40px"></i><div>Error! No ha sigut possible desvincular l'usuari del grup seleccionat.</div></div>`);
		    	$('#assignarGrupModalBtns').html(`<button class="reloadBtn btn btn-primary mr-2">Acceptar</button>`);
		    }

		    $('body').on('click', '.cancelAssignarGrupBtn', function()  {
		    	$('#grup').prop('selectedIndex',0);
		    	$('#assignarGrupModal').modal('hide');
		    });

		    $('body').on('change', '#grup', function() {
		    	if ($(this).val() != '') {
		    		$('#grupAssignatBtn').removeClass('disabled');
		    	} else {
		    		$('#grupAssignatBtn').addClass('disabled');
		    	}
		    });

		    $('body').on('click', '#grupAssignatBtn', function(e) {
		    	var id = $('#grupAssignatBtn').data('id');
		    	var grup = $('#grup').val();
		    	var url = `{{ path('assignarGrupAjax') }}`;
		    	$.post(url, { 'idUsuari': id, 'grup': grup }) 
		    		.done(function() {
						$('#assignarGrupModalMsg').html(`<div class="text-center"><i class="fas fa-check mb-2" style="color: green; font-size: 40px"></i><div>Grup assignat correctament.</div></div>`);
		    			$('#assignarGrupModalBtns').html(`<button class="reloadBtn btn btn-primary mr-2">Acceptar</button>`);
		    			
					})
					.fail(errorAssignacioGrup);
		    	e.preventDefault();
		    });

		    function errorAssignacioGrup() {
		    	$('#assignarGrupModalMsg').html(`<div class="text-center"><i class="fas fa-exclamation-triangle mb-2" style="color: red; font-size: 40px"></i><div>Error! No ha sigut possible assignar el grup a l'usuari.</div></div>`);
		    	$('#assignarGrupModalBtns').html(`<button class="reloadBtn btn btn-primary mr-2">Acceptar</button>`);
		    }

		    $('body').on( 'click', '.eliminarUsuariBtn', function() {
		    	var id = $(this).data('id');
		    	var usuari = $(this).data('usuari');
		    	$('#eliminarUsuariModalTitol').html(`Eliminar l'usuari <strong>${usuari}</strong>`);
		    	$('#eliminarUsuariModalMsg').html(`<div class="text-center"><i class="fas fa-user-times mb-2" style="color: red; font-size: 40px"></i><div><strong>Atenció!</strong> Estàs segur que vols eliminar aquest usuari?<div class="alert alert-warning mt-2" style="font-size:11px;">Es perdrà tota la informació relacionada amb aquest usuari.</div></div></div>`);
		    	$('#eliminarUsuariModalBtns').html(`<button class="cancelEliminarUsuariBtn btn btn-secondary mr-2">Cancel·lar</button><button data-id="${id}" id="usuariEliminatBtn" class="btn btn-primary">Continuar</button>`);
		    	$('#eliminarUsuariModal').modal('show');
		    });

		    $('body').on('click', '#usuariEliminatBtn', function(e) {
		    	var id = $('#usuariEliminatBtn').data('id');
		    	var url = `{{ path('eliminarAlumneAjax') }}`;
		    	$.post(url, { 'idUsuari': id }) 
		    		.done(function(response) {
						$('#eliminarUsuariModalMsg').html(`<div class="text-center"><i class="fas fa-user-slash mb-2" style="color: green; font-size: 40px"></i><div>L'usuari s'ha eliminat correctament.</div></div>`);
		    			$('#eliminarUsuariModalBtns').html(`<button class="reloadBtn btn btn-primary mr-2">Acceptar</button>`);
		    			
					})
					.fail(errorEliminacioUsuari());
		    	e.preventDefault();
		    });

		    $('body').on('click', '.cancelEliminarUsuariBtn', function()  {
		    	$('#eliminarUsuariModal').modal('hide');
		    });

		    function errorEliminacioUsuari() {
		    	$('#eliminarUsuariModalMsg').html(`<div class="text-center"><i class="fas fa-exclamation-triangle mb-2" style="color: red; font-size: 40px"></i><div>Error! No ha sigut possible eliminar l'usuari.</div></div>`);
		    	$('#eliminarUsuariModalBtns').html(`<button class="reloadBtn btn btn-primary mr-2">Acceptar</button>`);
		    }



		} );
	</script>
{% endblock %}
